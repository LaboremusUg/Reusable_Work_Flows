name: Root_manual_node_workflow
on:
  workflow_call:
    inputs:
      CLIENT_ENV:
        type: string
      WEBDEPLOY_USER:
        type: string
      REPO_NAME:
        type: string
      BUILD_FOLDER:
        type: string
    secrets:
      WEBDEPLOY_PASSWORD:
        required: true

jobs:
  Build-Package-IIS_Deploy:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14.x
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run unit tests
      run: npm run test

    - name: Create Distribution for ${{inputs.APP_NAME}}
      run:  npm run build-${{inputs.CLIENT_ENV}}
      env:
        CI: ""
        
    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v2
      with:
        name: ${{inputs.REPO_NAME}}-${{ inputs.CLIENT_ENV }}
        path: ${{inputs.BUILD_FOLDER}}
        
    - name: Download artifact from build job
      uses: actions/download-artifact@v2
      with:
        name: ${{inputs.REPO_NAME}}-${{ inputs.CLIENT_ENV }}

    - name: Deploy to Azure WebApp
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
         app-name: ${{ inputs.AZURE_WEBAPP_NAME }}
         publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
         package: ./${{inputs.REPO_NAME}}-${{ inputs.CLIENT_ENV }}
         slot-name: ${{ inputs.SLOT_NAME }}
